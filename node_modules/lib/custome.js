
function onId() {
    var token = $("#cht_token").val();
    return token;
}

function onSpeaker() {
	let onspeak = localStorage.getItem('ctspeaker');
	if(onspeak == "1") {
		document.getElementById("chat_menu_speaker").innerHTML = "<i class='zmdi zmdi-volume-off'></i>";
		localStorage.setItem('ctspeaker', "0");
	} else {
		document.getElementById("chat_menu_speaker").innerHTML = "<i class='zmdi zmdi-volume-up'></i>";
		localStorage.setItem('ctspeaker', "1");
	}
}

function onEndSession() {
	// alert('end session');
	swal({
		title: "Are you sure?",
		text: "Are you sure you want to end this conversation?",
		icon: "warning",
		dangerMode: true,
	  })
	  .then(willYes => {
		if (willYes) {
		let encr = localStorage.getItem('ctunikeys');
	
		let parm = { parms : encr }
		  $.ajax({
			url : "service/unsess.php",
			type: "POST",
			data : parm,
			success: function(data, textStatus, jqXHR) {
			var js  = JSON.parse(data);
			var stt = js['status'];
			if(stt == "1") {
				swal("end!", "You have successfully ended the conversation!", "success");
		  		localStorage.removeItem("ctunikeys");
				localStorage.removeItem("ctspeaker");
				location.reload();
			}

			},
			error: function (jqXHR, textStatus, errorThrown) {
	
			}
	});
		}
	  });
}

function openChat(ctchat, cttime) {

    hideChat(1);
    var comHead = "<div class='chat_header'>"+
    "<div class='chat_option'>"+
    "<div class='header_img'>"+
    "<img class='agent' src='assets/images/agent-avatar.jpg'/>"+
    "<div class='status_in' id='status_in'>"+
    "<img class='chat_inconnected_img' src='assets/images/wifi.png' />"+
    "</div>"+
    "</div>"+
    "<span id='chat_head'>Live Chat</span> <br> <span  id='chat_title' class='agent'>Layanan Pelanggan kami tersedia.</span>"+
    "<div class='chat_menu_speaker' id='chat_menu_speaker' onClick='onSpeaker();'>"+
    "<i class='zmdi zmdi-volume-up'></i>"+
    "</div>"+
    "<div class='chat_dropdown'>"+
    "<button class='chat_dropbtn'><i class='fullscreen zmdi zmdi-widgets'></i></button>"+
    "<div class='chat_dropdown_content'>"+
    "<a href='#' onClick='onEndSession();'><i class='zmdi zmdi-close-circle-o'></i> End the Conversation</a>"+
    "</div>"+
    "</div>"+
    "</div>"+
    "</div>";
    $( "div.fab_comp_head" ).replaceWith(comHead);

    var comChat = "<div class='fab_field fab_field2'>"+
    "<div class='chat_dropbott'>"+
    "<button class='chat_dropbtt'><i class='zmdi zmdi-camera'></i></button>"+
    "<div class='chat_dropbott_content'>"+
    "<a href='#' onClick='onEndSession();'>"+
    "<i class='zmdi zmdi-collection-image-o'></i> &nbsp;Galery</a>"+
    "<a href='#' onClick='onEndSession();'>"+
    "<i class='zmdi zmdi-folder-outline'></i> &nbsp;Document</a>"+
    "</div>"+
    "</div>"+
    "<a id='fab_send' class='fab is-visible' onClick='sendChat();'>"+"<i class='zmdi zmdi-mail-send'>"+"</i>"+"</a>"+
    "<textarea id='chat_message' name='chat_message' placeholder='Send a message' class='chat_field chat_message'>"+"</textarea>"+
    "</div>";
    $( "div.fab_comp_chat" ).replaceWith(comChat);

    $("#chat_message").emojioneArea({
        search: false,
        autocomplete: false,
        events: {
            keypress: function (editor, event) {
                console.log("is tyiping... "+event.which);
                $('div.emojionearea-editor').attr('id', 'emojionearea-editor');
                if(event.which == 13){
                    // $(".emojionearea").removeClass("focused");
                    var newmsg = editor.html(); //this.getText();
                    
                    if(newmsg != "" && newmsg != "\n" && clconn == "1") {
                        var ctunikeys = localStorage.getItem('ctunikeys');
                        socket.emit('message_inb', { chatmsg: newmsg, ctunikeys: ctunikeys });
                        
                        setTimeout(function() {
                            $("div.emojionearea-editor").html('');
                            $("#chat_message").val(editor.html(''));
                            $("#emojionearea-editor").data("emojioneArea").setText('');
                        }, 100);
                    }
                }
            }
        }
    });

    var msg = '<span class="chat_msg_item chat_msg_item_user">'+
    ctchat+'</span>'+
    '<span class="status">'+cttime+'</span>';
        document.getElementById("chat_hist").innerHTML = msg;
    var elmt = document.getElementById("chat_converse");
    elmt.scrollTop = elmt.scrollHeight;
}